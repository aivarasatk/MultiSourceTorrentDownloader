<Window x:Class="MultiSourceTorrentDownloader.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:fa="http://schemas.fontawesome.io/icons/"
        xmlns:model="clr-namespace:MultiSourceTorrentDownloader.Models"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:i = "http://schemas.microsoft.com/expression/2010/interactivity"
        xmlns:behaviors="clr-namespace:MultiSourceTorrentDownloader.Behaviors"
        xmlns:converters="clr-namespace:MultiSourceTorrentDownloader.Converters"
        xmlns:enums="clr-namespace:MultiSourceTorrentDownloader.Enums"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="15"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}"
        mc:Ignorable="d"
        Title="App"
        ResizeMode="CanResizeWithGrip"
        MinWidth="715"
        MinHeight="440"
        d:DataContext="{d:DesignInstance d:Type=model:MainModel}"
        x:Name="MainWindowElement">
    
    <!-- Sets and saves window SizeToContent and Width/Height-->
    <i:Interaction.Behaviors>
        <behaviors:PersistanceBehavior />
    </i:Interaction.Behaviors>
    
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.DialogHost.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Command="{Binding SearchCommand}" Key="Enter" />
    </Window.InputBindings>

    <!-- TORRENT INFO CONTROL -->
    <materialDesign:DialogHost Identifier="RootDialog" CloseOnClickAway="True"> <!-- to show in-window popups-->
        <Grid>
            <Grid.Resources>
                <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
                <converters:MessageTypeToBackgroundConverter x:Key="MessageTypeToBackgroundConverter"/>
                <converters:TimeFormatConverter x:Key="TimeFormatConverter"/>
                <converters:TorrentCategoryToBooleanConverter x:Key="TorrentCategoryToBooleanConverter"/>
            </Grid.Resources>

            <Grid>

                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="auto"/>
                </Grid.RowDefinitions>

                <GroupBox Grid.Row="0" Margin="16" Header="Search Criteria">
                    <Grid FocusManager.FocusedElement="{Binding ElementName=SearchBox}" Margin="16,16,0,0">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal">
                            <TextBox x:Name="SearchBox" Style="{StaticResource MaterialDesignFloatingHintTextBox}" 
                                    Text="{Binding SearchValue, UpdateSourceTrigger=PropertyChanged}"                                    
                                    TextWrapping="NoWrap"
                                    Width="300"
                                    materialDesign:HintAssist.Hint="Search for torrents.." 
                                    ToolTip="Pressing enter will activate search"/>


                            <Button Command="{Binding SearchCommand}" Height="39" Width="60">
                                <materialDesign:PackIcon Kind="Search" Width="27" Height="35"/>
                            </Button>

                            <ComboBox ItemsSource="{Binding Filters}" SelectedItem="{Binding SelectedFilter}" DisplayMemberPath="Value" HorizontalAlignment="Left" Margin="48,0,0,0"/>

                            <StackPanel Orientation="Horizontal" Margin="104,0,0,0">
                                <TextBlock Text="Sources: " VerticalAlignment="Center"/>
                                <ListBox x:Name="SelectableSources"  ItemsSource="{Binding AvailableSources}">
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>

                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Content="{Binding SourceName}" IsChecked="{Binding Selected}">
                                                <i:Interaction.Behaviors>
                                                    <behaviors:RaiseCanExecuteBehavior Command1="{Binding ElementName=SelectableSources, Path=DataContext.SearchCommand}"
                                                                                       Command2="{Binding ElementName=SelectableSources, Path=DataContext.LoadMoreCommand}"/>
                                                </i:Interaction.Behaviors>
                                            </CheckBox>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </StackPanel>
                        
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,24,16,16">
                            <RadioButton GroupName="categories" Content="All" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.All}}" Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="Movies" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.Movies}}" Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="TV" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.TV}}" Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="Games" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.Games}}" Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="Music" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.Music}}" Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="Applications" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.Applications}}"  Margin="0,0,16,0"/>
                            <RadioButton GroupName="categories" Content="XXX" IsChecked="{Binding SelectedTorrentCategory, Converter={StaticResource TorrentCategoryToBooleanConverter}, ConverterParameter={x:Static enums:TorrentCategory.XXX}}" />
                        </StackPanel>
                    </Grid>
                    
                </GroupBox>

                <GroupBox Grid.Row="1" Margin="16" Header="Torrents">
                    <Grid Margin="8">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="auto"/>
                        </Grid.RowDefinitions>

                        <TextBox Grid.Row="0" Text="{Binding TorrentFilter, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource MaterialDesignFloatingHintTextBox}" 
                                 HorizontalAlignment="Left"
                                 Margin="0,8,8,8"
                                 Width="300"
                                 materialDesign:HintAssist.Hint="Filter titles..."/>



                        <DataGrid x:Name="TorrentGrid" Grid.Row="1" 
                                  ItemsSource="{Binding TorrentEntries}" 
                                  SelectedItem="{Binding SelectedTorrent}" 
                                  IsReadOnly="True" 
                                  AutoGenerateColumns="False" 
                                  SelectionMode="Single">
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Title" CanUserSort="True" SortMemberPath="Title">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock>
                                                <Hyperlink Command="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Window}}, Path=DataContext.OpenTorrentInfoCommand}" 
                                                           CommandParameter="{Binding}" >
                                                    <TextBlock Text="{Binding Title}" FontWeight="Bold" />
                                                </Hyperlink>        
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Seeders" Foreground="Green" Binding="{Binding Seeders}" CanUserSort="True"/>
                                <DataGridTextColumn Header="Leechers" Foreground="Red" Binding="{Binding Leechers}" CanUserSort="True"/>
                                <DataGridTextColumn Header="Time" Foreground="Black" Binding="{Binding Date, Converter={StaticResource TimeFormatConverter}}" CanUserSort="True"/>
                                <DataGridTextColumn Header="Size" Foreground="Black" Binding="{Binding Size}" CanUserSort="True"/>
                                <DataGridTextColumn Header="Uploader" Foreground="Black" Binding="{Binding Uploader}" CanUserSort="True"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="2" Command="{Binding LoadMoreCommand}" Content="Load more" Margin="0,16,0,0" Width="120" HorizontalAlignment="Center"
                                ToolTip="Loads more data from next torrent page"/>
                    </Grid>
                    
                </GroupBox>

                <StackPanel Grid.Row="2"  Background="{Binding MessageType, Converter={StaticResource MessageTypeToBackgroundConverter}}">
                    <TextBlock Margin="8" Text="{Binding StatusBarMessage}" Foreground="White"/>
                </StackPanel>
               
            </Grid>

            <Grid Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel Background="LightGray" Opacity="0.5"/>
                <!-- prevents user clicks-->
                <fa:ImageAwesome Icon="Spinner" Spin="True" SpinDuration="2" Width="40" Height="40" Visibility="Visible" Margin="16,16,16,16"/>
            </Grid>
        </Grid>
    </materialDesign:DialogHost>
</Window>
